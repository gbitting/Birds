import pandas as pd
import math as m
import numpy as np
import matplotlib.pyplot as plt
from astral import LocationInfo
from astral.sun import sun


# 1
data = pd.read_csv(
    "bird_jan25jan16.txt", 
    sep=r"\s+", engine = 'python', 
    parse_dates=[[0, 1]], 
    names = ['date', 'time', 'count']
    )
birds = pd.DataFrame(data)

birds['date_time'] = pd.to_datetime(birds['date_time'])

# 2
birds['date_time'] = birds['date_time'].dt.tz_localize('UTC')
birds['date_time'] = birds['date_time'].dt.tz_convert('Europe/Stockholm')

birds = birds.set_index('date_time')
birds.head()


# 4

df = pd.read_csv('ProcessedBirdData.csv', sep="\t", names=["date_time", "count"], index_col = False)

#df =  df.iloc[1:].reset_index(drop = True)

df["date_time"] = pd.to_datetime(df["date_time"], format = "mixed")
df["count"] = pd.to_numeric(df["count"])
start_date = pd.to_datetime(input("Enter start date: ")).tz_localize("Europe/Stockholm")
days = int(input("Enter number of days: "))
interval = pd.Timedelta(input('Enter inerval between readings (write the value and then the unit of the time division seperated by a space): '))



end_date = start_date + pd.Timedelta(days=days)

df = df[
    (df["date_time"] >= start_date) &
    (df["date_time"] < end_date)
]

df["count"] = df["count"].diff()

#resampling


df = df.set_index("date_time")

resampled_df = df.resample(interval).sum().reset_index()


# Plotting

fig, ax = plt.subplots(figsize=(12,6))

# Plotting bars
ax.bar(resampled_df["date_time"], resampled_df["count"], width=0.03)

# Setting x-ticks for every 3 hours

ax.set_xticks(resampled_df["date_time"])

ax.set_xticklabels(
    [
    dt.strftime("%H") if dt.hour % 3 == 0 else "" for dt in resampled_df['date_time']
    ],
    rotation=45)


unique_dates = resampled_df['date_time'].dt.date.unique()

city = LocationInfo("Lund", "Sweden", "Europe/Stockholm", 55.7, 13.2)

# Creating a dictionary with the sun times
sun_times = { 
    day: sun(city.observer, date =day, tzinfo=city.timezone)
    for day in unique_dates
    }


first_day = True
for day, times in sun_times.items():
    sunrise = times['sunrise']
    sunset = times['sunset']
    
    ax.axvspan(sunrise,sunset,color="orange",alpha=0.4)
    
    ax.axvline(sunrise, color='red', linestyle='--',label="sunrise"  if first_day else None)
    ax.axvline(sunset, color='orange', linestyle='--', label="sunset" if first_day else None)
    first_day = False


# Seconday axis 

midnight_mask = resampled_df["date_time"].dt.hour.eq(0)
midnight_positions = resampled_df["date_time"][midnight_mask]

sec = ax.secondary_xaxis('bottom')
sec.set_xticks(midnight_positions)
sec.set_xticklabels(midnight_positions.dt.date)
sec.tick_params(length=1.0, pad=25)

plt.legend()

ax.set_title("Nesting box activities, SÃ¶dra Sandby, Garage")

ax.set_xlabel("Time")
ax.set_ylabel("Bird Movements")
plt.tight_layout()
plt.show()

